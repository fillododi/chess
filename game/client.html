<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <h1>Chess</h1>
    <button id="btnCreate">New Game</button>
    <button id="btnJoin">Join Game</button>
    <input type="text" id="joinGameIdTxt"/>
    <div id="divPlayers"></div>
    <div id="divBoard"></div>
    <script>
        //dichiarazione variabili
        let clientId = null
        let gameId = null
        let ws = new WebSocket("ws://localhost:5000")
        const btnCreate = document.getElementById("btnCreate")
        const btnJoin = document.getElementById("btnJoin")
        const txtJoin = document.getElementById("joinGameIdTxt")
        const divPlayers = document.getElementById("divPlayers")
        const divBoard = document.getElementById("divBoard")

        btnCreate.addEventListener("click", e => { //click sul bottone crea partita
            const payload = { //richiesta che verrà mandata
                "method": "create",
                "clientId": clientId
            }
            ws.send(JSON.stringify(payload)) //invia richiesta
        })

        btnJoin.addEventListener("click", e => { //click sul bottone entra in partita
            gameId = txtJoin.value //id partita inserito
            const payload = { //richiesta che verrà mandata
                "method": "join",
                "clientId": clientId,
                "gameId": gameId
            }
            ws.send(JSON.stringify(payload)) //invia richiesta
        })

        ws.onmessage = message => { //quando si ricevono risposte dal server
            const response = JSON.parse(message.data) //estrae risposta
            if(response.method === "connect"){ //risposta che arriva quando il client si connette, ottenendo il client id
                clientId = response.clientId
                console.log("Client id is ", response.clientId)
            }
            if(response.method === "create"){ //risposta alla creazione della partita, in cui si ottiene il gameid
                gameId = response.gameId
                console.log("Created game with id ", response.gameId)

                //richiesta di unione alla partita appena creata
                const payload = { //richiesta che verrà mandata
                    "method": "join",
                    "clientId": clientId,
                    "gameId": gameId
                }
                ws.send(JSON.stringify(payload)) //invia richiesta
            }
            if(response.method === "join"){ //risposta all'entrata in partita
                const game = response.game //dati di gioco iniziali: chi è connesso, chi è bianco e nero etc.
                while(divPlayers.firstChild){ //libera spazio con scritte di chi è connesso
                    divPlayers.removeChild(divPlayers.firstChild)
                }
                while(divBoard.firstChild){ //libera spazio scacchiera
                    divBoard.removeChild(divBoard.firstChild)
                }
                //SCACCHIERA
                const txt = document.createElement("p")
                txt.innerHTML = "Scacchiera della partita " + game.id
                divBoard.appendChild(txt)
                for(let i = 0; i < 8; i++){
                    const c = document.createElement("div")
                    c.id = "casella" + i
                    c.style.backgroundColor = "red"
                    c.style.width = "200px"
                    c.style.height = "200px"
                    c.style.border = "1px solid black"
                    divBoard.appendChild(c)
                }

                //SPAZIO CON SCRITTO CHI E' CONNESSO
                game.clients.forEach(client => {
                    const d = document.createElement("div")
                    d.style.width = "200px"
                    d.style.border = "1px solid black"
                    d.textContent = "client connesso: " + client.clientId
                    divPlayers.appendChild(d)
                })
            }
            if(response.method === "leave"){ //notifica che qualcuno è uscito dalla partita
                const game = response.game
                const leavingPlayer = response.leavingPlayer
                while(divPlayers.firstChild){ //libera spazio con scritte di chi è connesso
                    divPlayers.removeChild(divPlayers.firstChild)
                }
                while(divBoard.firstChild){ //libera spazio scacchiera
                    divBoard.removeChild(divBoard.firstChild)
                }
                //SCACCHIERA
                const txt = document.createElement("p")
                txt.innerHTML = "Scacchiera della partita " + game.id + " - TERMINATA"
                divBoard.appendChild(txt)
                const txtAlert = document.createElement("p")
                txtAlert.style.color = "red"
                txtAlert.innerHTML = leavingPlayer + " ha lasciato la partita"
                divBoard.appendChild(txtAlert)
                for(let i = 0; i < 8; i++){
                    const c = document.createElement("div")
                    c.id = "casella" + i
                    c.style.backgroundColor = "red"
                    c.style.width = "200px"
                    c.style.height = "200px"
                    c.style.border = "1px solid black"
                    divBoard.appendChild(c)
                }
            }
        }
    </script>
</body>
</html>